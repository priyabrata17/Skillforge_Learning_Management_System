<% layout("layouts/boilerplateAdminPanel") %>

  <body>

    <!-- Begin Page Content -->
    <div class="container-fluid">

      <!-- Page Heading -->
      <h1 class="h3 mb-2 text-gray-800">All Users</h1>
      <p class="mb-4">
        Manage all registered users from the admin panel. You can edit roles or remove users from here.
      </p>

      <!-- DataTables Example -->
      <div class="card shadow mb-4">

        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">Users List</h6>
        </div>

        <div class="card-body">
          <div class="table-responsive">

            <table class="table table-bordered table-hover align-middle" id="dataTable" width="100%" cellspacing="0">

              <thead class="thead-light">
                <tr>
                  <th>SN</th>
                  <th>Image</th>
                  <th>Full Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Role Description</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>

              <tbody>
                <% if (allUsers && allUsers.length> 0) { %>
                  <% allUsers.forEach((user, index)=> { %>

                    <tr>

                      <td>
                        <%= index + 1 %>
                      </td>

                      <td class="text-center">
                        <img src="<%= user.image?.url || '/images/default-avatar.png' %>" alt="<%= user.fullName %>"
                          class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                      </td>

                      <td>
                        <%= user.fullName %>
                      </td>
                      <td>
                        <%= user.email %>
                      </td>

                      <td>
                        <span class="badge badge-info text-uppercase">
                          <%= user.role %>
                        </span>
                      </td>

                      <td>
                        <%= user.roleDescription || '—' %>
                      </td>

                      <td class="text-center">
                        <% if (currAdmin && currAdmin._id.toString() !==user._id.toString()) { %>

                          <a href="/admin/update/user-page/<%= user._id %>" class="btn btn-sm btn-primary mr-1">
                            <i class="fas fa-edit"></i> Edit
                          </a>

                          <button class="btn btn-sm btn-danger" data-toggle="modal"
                            data-target="#deleteUserModal_<%= user._id %>">
                            <i class="fas fa-trash-alt"></i> Delete
                          </button>

                          <% } else { %>
                            <span class="text-muted">—</span>
                            <% } %>
                      </td>

                    </tr>

                    <% }) %>

                      <% } else { %>
                        <tr>
                          <td colspan="7" class="text-center text-muted">No users found.</td>
                        </tr>
                        <% } %>

              </tbody>

            </table>

          </div>
        </div>

      </div>

    </div> <!-- container-fluid -->

    <!-- ============================
       DELETE CONFIRMATION MODALS
       (Placed outside table)
  ============================ -->
    <% if (allUsers && allUsers.length> 0) { %>
      <% allUsers.forEach((user)=> { %>

        <div class="modal fade" id="deleteUserModal_<%= user._id %>" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>

              <div class="modal-body">
                Are you sure you want to delete <strong>
                  <%= user.fullName %>
                </strong>? <br>
                This action cannot be undone.
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>

                <form action="/admin/delete/user/<%= user._id %>?_method=DELETE" method="POST">
                  <button type="submit" class="btn btn-danger">Yes, Delete</button>
                </form>
              </div>

            </div>
          </div>
        </div>

        <% }) %>
          <% } %>

            <nav aria-label="Pagination">
              <ul class="pagination justify-content-center">

                <% if (hasPrevPage) { %>
                  <li class="page-item">
                    <a class="page-link" href="?page=<%= prevPage %>">Previous</a>
                  </li>
                  <% } else { %>
                    <li class="page-item disabled">
                      <span class="page-link">Previous</span>
                    </li>
                    <% } %>

                      <% for (let i=1; i <= totalPages; i++) { %>
                        <li class="page-item <%= i === page ? 'active' : '' %>">
                          <a class="page-link" href="?page=<%= i %>">
                            <%= i %>
                          </a>
                        </li>
                        <% } %>

                          <% if (hasNextPage) { %>
                            <li class="page-item">
                              <a class="page-link" href="?page=<%= nextPage %>">Next</a>
                            </li>
                            <% } else { %>
                              <li class="page-item disabled">
                                <span class="page-link">Next</span>
                              </li>
                              <% } %>

              </ul>
            </nav>


  </body>